<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mess Menu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .active-tab { background-color: cyan !important; font-weight: bold; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .extra-messing { font-size: 0.85rem; font-style: italic; color: gray; text-align: right; }
    </style>
</head>
<body onload="loadMenu()">

    <div class="container mt-4">
        <h2 class="text-center text-danger">UDAIGIRI MESS MENU</h2>
        <h4 class="text-center" id="currentDate"></h4>
        
        <div class="progress">
            <div id="progressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%;" 
                aria-valuemin="0" aria-valuemax="100">
                0 mins left
            </div>
        </div>

        <div class="d-flex justify-content-center mt-3">
            <button class="btn btn-light mx-2" onclick="changeDate(-1)">◀</button>
            <button id="Breakfast" class="btn btn-outline-dark mx-1" onclick="loadMenu('Breakfast')">Breakfast</button>
            <button id="Lunch" class="btn btn-outline-dark mx-1" onclick="loadMenu('Lunch')">Lunch</button>
            <button id="Snacks" class="btn btn-outline-dark mx-1" onclick="loadMenu('Snacks')">Snacks</button>
            <button id="Dinner" class="btn btn-outline-dark mx-1" onclick="loadMenu('Dinner')">Dinner</button>
            <button class="btn btn-light mx-2" onclick="changeDate(1)">▶</button>
        </div>

        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Item</th>
                </tr>
            </thead>
            <tbody id="menuTable"></tbody>
        </table>

        <p class="extra-messing"><strong>Extra messing:</strong> <span id="extraMessing"></span></p>
    </div>

    <script>
        let currentDate = new Date();
        const daysOfWeek = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
        
        const mealTimings = {
            "Breakfast": [7, 30, 9, 30],
            "Lunch": [12, 0, 14, 0],
            "Snacks": [16, 30, 17, 30],
            "Dinner": [19, 0, 21, 0]
        };

        function updateDateDisplay() {
            document.getElementById("currentDate").innerText = 
                currentDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function getCurrentOrNextMeal() {
            let now = new Date();
            let closestMeal = null;
            let minDiff = Infinity;

            for (let meal in mealTimings) {
                let [startH, startM, endH, endM] = mealTimings[meal];
                let startTime = new Date();
                startTime.setHours(startH, startM, 0);
                let endTime = new Date();
                endTime.setHours(endH, endM, 0);

                if (now >= startTime && now <= endTime) {
                    let timeLeft = Math.round((endTime - now) / 60000);
                    document.getElementById("progressBar").style.width = (timeLeft / 120) * 100 + "%";
                    document.getElementById("progressBar").innerText = timeLeft + " mins left";
                    return meal;
                }

                let timeDiff = startTime - now;
                if (timeDiff > 0 && timeDiff < minDiff) {
                    minDiff = timeDiff;
                    closestMeal = meal;
                }
            }
            return closestMeal || "Breakfast"; // Default to next available meal
        }

        function loadMenu(selectedMeal = null) {
            let currentDay = daysOfWeek[currentDate.getDay()];
            let activeMeal = selectedMeal || getCurrentOrNextMeal();

            fetch("menu.csv")
                .then(response => response.text())
                .then(csvData => {
                    let data = Papa.parse(csvData.trim(), { header: true, skipEmptyLines: true }).data;
                    let menuTable = document.getElementById("menuTable");
                    let extraMessingList = [];

                    menuTable.innerHTML = "";
                    data.forEach(row => {
                        if (row[currentDay] && row.time === activeMeal) {
                            if (row.type.trim().toLowerCase() === "extra messing") {
                                extraMessingList.push(row[currentDay]);
                            } else {
                                let tr = document.createElement("tr");
                                tr.innerHTML = `<td>${row.type}</td><td>${row[currentDay]}</td>`;
                                menuTable.appendChild(tr);
                            }
                        }
                    });

                    document.getElementById("extraMessing").innerText = extraMessingList.join(", ") || "None";

                    document.querySelectorAll(".btn-outline-dark").forEach(btn => btn.classList.remove("active-tab"));
                    document.getElementById(activeMeal).classList.add("active-tab");
                })
                .catch(error => console.error("Error loading CSV:", error));

            updateDateDisplay();
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            loadMenu();
        }

        loadMenu();
    </script>

</body>
</html>