<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Udaigiri Mess | Menu</title>
    <link rel="icon" type="image/x-icon" href="assets/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #d9534f;
            --secondary-color: #f9f9f9;
            --accent-color: #5cb85c;
            --text-color: #333;
            --light-gray: #f4f4f4;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 45px;
            margin-right: 15px;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Progress Bar - IMPROVED */
        .progress-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: var(--border-radius);
            position: relative;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .progress-bar-indicator {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: var(--border-radius);
            transition: width 0.5s ease-in-out;
        }

        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Meal Tabs - REDESIGNED */
        .meal-tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }

        .meal-tab-buttons {
            display: flex;
            gap: 5px;
            flex-grow: 1;
            justify-content: center;
        }

        .nav-btn {
            border: none;
            background: none;
            font-size: 1.8rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0 10px;
        }

        .btn-meal {
            flex-grow: 1;
            border: 1px solid #ddd;
            background-color: #fff;
            color: var(--text-color);
            padding: 10px 5px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .btn-meal:hover {
            background-color: #f0f0f0;
            border-color: var(--primary-color);
        }

        .btn-meal.active-tab {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }

        .btn-meal i {
            font-size: 1.2rem;
        }

        /* Menu Table - REDESIGNED */
        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .table thead {
            background-color: var(--primary-color);
            color: white;
        }

        .table td,
        .table th {
            padding: 1rem;
            vertical-align: middle;
        }

        .table-striped>tbody>tr:nth-of-type(odd)>* {
            background-color: #fafafa;
        }

        /* General UI Cards */
        .content-card {
            background: #fff;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 2rem;
        }

        .content-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 8px;
        }

        .form-submit {
            background-color: var(--primary-color);
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            border: none;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .form-submit:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .btn-download {
            background-color: var(--primary-color);
            border: none;
            border-radius: 50%;
            color: white;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }

        /* Footer */
        .footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }

        .footer a {
            color: #fff;
            font-weight: 600;
        }

        /* AI Section Specific Styles */
        #ai-response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            min-height: 100px;
            white-space: normal;
            /* Changed from pre-wrap */
        }

        #ai-response p,
        #ai-response ul,
        #ai-response li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <img src="assets/logo.png" alt="Udaigiri Logo" class="logo">
        <h1 class="header-title">UDAIGIRI MESS MENU</h1>
    </header>

    <div class="container mt-4">
        <h4 class="text-center fw-bold" id="currentDate"></h4>

        <div class="progress-container">
            <div id="progressBarIndicator" class="progress-bar-indicator"></div>
            <div id="progressBarText" class="progress-bar-text">Loading...</div>
        </div>

        <div class="meal-tabs mt-4">
            <button class="nav-btn" onclick="changeDate(-1)" aria-label="Previous Day"><i
                    class="fas fa-chevron-left"></i></button>
            <div class="meal-tab-buttons">
                <button id="Breakfast" class="btn-meal" onclick="loadMenuByUser('breakfast')"><i
                        class="fas fa-mug-saucer"></i><span>Breakfast</span></button>
                <button id="Lunch" class="btn-meal" onclick="loadMenuByUser('lunch')"><i
                        class="fas fa-utensils"></i><span>Lunch</span></button>
                <button id="Snacks" class="btn-meal" onclick="loadMenuByUser('snacks')"><i
                        class="fas fa-cookie-bite"></i><span>Snacks</span></button>
                <button id="Dinner" class="btn-meal" onclick="loadMenuByUser('dinner')"><i
                        class="fas fa-drumstick-bite"></i><span>Dinner</span></button>
            </div>
            <button class="nav-btn" onclick="changeDate(1)" aria-label="Next Day"><i
                    class="fas fa-chevron-right"></i></button>
        </div>

        <table class="table table-striped table-bordered mt-4">
            <thead>
                <tr>
                    <th style="width: 30%;">Type</th>
                    <th>Item</th>
                </tr>
            </thead>
            <tbody id="menuTable"></tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <p class="mb-1"><strong>Extra messing*:</strong> <span id="extraMessing"></span></p>
                <p class="text-muted" style="font-size: 0.8rem; font-style: italic;">
                    *Availability is subject to change based on Mess workload.
                </p>
            </div>
            <a href="assets/menus/aug2025.pdf" download>
                <button class="btn-download"><i class="fa fa-download"></i></button>
            </a>
        </div>
    </div>

    <div class="container">
        <section class="content-card">
            <h2 class="content-card-title">🤖 AI Dietitian</h2>
            <p class="text-muted mb-3">Get personalized meal suggestions based on the selected menu above.</p>
            <div class="mb-3">
                <label for="ai-prompt" class="form-label">What's your goal or requirement?</label>
                <input id="ai-prompt" type="text" class="form-control"
                    placeholder="e.g., 'I want a high-protein meal' or 'Suggest a balanced plate'">
            </div>
            <button id="get-suggestion-btn" class="form-submit" onclick="getDietitianSuggestion()">
                Get Suggestion
            </button>
            <div id="ai-response-container" class="mt-4" style="display: none;">
                <h5 class="fw-bold">Gemini's Suggestion:</h5>
                <div id="ai-response" class="p-3 rounded"></div>
            </div>
        </section>

        <section class="content-card">
            <h2 class="content-card-title">General Guidelines</h2>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">🍽️ <b>Mess SOP:</b> Please follow <a href="assets/sop.jpeg"
                        class="text-decoration-none fw-bold">the guidelines</a> and maintain cleanliness.</li>
                <li class="list-group-item">🥗 <b>Extra Messing:</b> Available at lunch (till 1:45 PM) every day except
                    Saturday & Sunday.</li>
                <li class="list-group-item">🧹 <b>Cleanliness:</b> Keeping the mess area clean is a shared
                    responsibility.</li>
                <li class="list-group-item">🔔 <b>Special Dietary Needs?</b> Inform the mess office in advance.</li>
                <li class="list-group-item">🎟️ <b>Coupons:</b> Collect Extra Messing coupons from the mess office or
                    entry gate.</li>
                <li class="list-group-item">⏳ <b>Timings:</b> Please stick to mess timings to ensure service.</li>
                <li class="list-group-item">⚠️ <b>Meal Issues?</b> Report any food quality problems immediately to the
                    mess staff.</li>
            </ul>
        </section>

        <section class="content-card">
            <h2 class="content-card-title">Suggestion Box</h2>
            <form action="https://api.web3forms.com/submit" method="POST">
                <input type="hidden" name="access_key" value="YourCode" />
                <input type="hidden" name="subject" value="New Suggestion from a student!" />
                <div class="mb-3">
                    <textarea class="form-control" name="message" rows="4" placeholder="Share your suggestions..."
                        required></textarea>
                </div>
                <button class="form-submit" type="submit">Submit Suggestion</button>
            </form>
        </section>

        <section class="content-card">
            <h2 class="content-card-title">Complaint Box</h2>
            <form action="https://api.web3forms.com/submit" method="POST">
                <input type="hidden" name="access_key" value="a91551ec-d2d3-41fe-831e-dde4564012ff" />
                <input type="hidden" name="subject" value="New Complaint from a student!" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="date" class="form-label">Date*</label>
                        <input id="date" name="date" type="date" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label for="mealType" class="form-label">Select Meal*</label>
                        <input id="mealType" name="mealType" type="text" class="form-control"
                            placeholder="e.g., Breakfast/Lunch" required />
                    </div>
                    <div class="col-md-6">
                        <label for="name" class="form-label">Name</label>
                        <input id="name" name="name" class="form-control" placeholder="Your name" type="text" />
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Phone*</label>
                        <input id="phone" name="phone" class="form-control" placeholder="+91 98765 43210" type="text"
                            required />
                    </div>
                    <div class="col-12">
                        <label for="message" class="form-label">Message*</label>
                        <textarea class="form-control" id="message" name="message" placeholder="Describe your complaint"
                            rows="4" required></textarea>
                    </div>
                </div>
                <button class="form-submit mt-3" type="submit">Submit Complaint</button>
            </form>
        </section>
    </div>

    <footer class="footer">
        <p class="mb-1">Made with <i class="fa fa-heart text-danger"></i> by <a href="https://proadhikary.github.io"
                target="_blank">@proadhikary</a></p>
        <p class="mb-0" style="font-size: 0.8rem;">Last Updated: July 19, 2025</p>
    </footer>

    <script>
        let menuData = {};
        let userDate = new Date();
        let userHasInteractedToday = false;
        const daysOfWeek = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];

        const mealTimings = {
            "breakfast": { start: [7, 30], end: [9, 30] },
            "lunch": { start: [12, 0], end: [14, 0] },
            "snacks": { start: [16, 30], end: [17, 30] },
            "dinner": { start: [19, 0], end: [21, 0] }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetch('assets/menus/aug-sept.json')
                .then(response => response.json())
                .then(data => {
                    menuData = data;
                    updateLiveState();
                    setInterval(updateLiveState, 1000);
                })
                .catch(error => console.error("Error loading menu data:", error));
        });

        function createDate(hours, minutes) {
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function getCurrentMealState() {
            const now = new Date();
            for (const meal in mealTimings) {
                const startTime = createDate(...mealTimings[meal].start);
                const endTime = createDate(...mealTimings[meal].end);
                if (now >= startTime && now <= endTime) {
                    return { meal, status: "ongoing", timeLeft: (endTime - now), totalDuration: (endTime - startTime), targetDate: now };
                }
            }

            for (const meal of ["breakfast", "lunch", "snacks", "dinner"]) {
                const startTime = createDate(...mealTimings[meal].start);
                if (now < startTime) {
                    return { meal, status: "upcoming", timeLeft: (startTime - now), targetDate: now };
                }
            }

            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            const nextBreakfastTime = createDate(...mealTimings.breakfast.start);
            nextBreakfastTime.setDate(tomorrow.getDate());
            return { meal: "breakfast", status: "upcoming", timeLeft: (nextBreakfastTime - now), targetDate: tomorrow };
        }

        function formatTime(ms) {
            const totalMinutes = Math.round(ms / 60000);
            const hrs = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            return hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
        }

        function updateLiveState() {
            const state = getCurrentMealState();
            updateProgressBar(state);

            if (isToday(userDate) && !userHasInteractedToday) {
                loadMenu(state.meal, state.targetDate);
            }
        }

        function updateProgressBar(state) {
            const { meal, status, timeLeft, totalDuration } = state;
            const indicator = document.getElementById("progressBarIndicator");
            const text = document.getElementById("progressBarText");

            if (status === "ongoing") {
                const progress = ((totalDuration - timeLeft) / totalDuration) * 100;
                indicator.style.width = `${progress}%`;
                text.innerText = `${meal.charAt(0).toUpperCase() + meal.slice(1)} ends in ${formatTime(timeLeft)}`;
            } else {
                indicator.style.width = `0%`;
                text.innerText = `Next: ${meal.charAt(0).toUpperCase() + meal.slice(1)} in ${formatTime(timeLeft)}`;
            }
        }

        function loadMenu(mealToShow, dateToShow) {
            const currentDay = daysOfWeek[dateToShow.getDay()];
            const menuTable = document.getElementById("menuTable");
            menuTable.innerHTML = "";

            const mealData = menuData[mealToShow];
            let extraMessingItem = "Not Available";

            if (mealData) {
                if (mealData["Meals"] && mealData["Meals"][currentDay]) {
                    const items = mealData["Meals"][currentDay].split(',');
                    items.forEach(item => {
                        if (item.trim()) {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `<td>Meal</td><td>${item.trim()}</td>`;
                            menuTable.appendChild(tr);
                        }
                    });
                } else {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>Meal</td><td>Not Available</td>`;
                    menuTable.appendChild(tr);
                }

                if (mealData["Extra Messing"] && mealData["Extra Messing"][currentDay]) {
                    extraMessingItem = mealData["Extra Messing"][currentDay];
                }
            }

            document.getElementById("extraMessing").innerText = extraMessingItem;
            updateDateDisplay(dateToShow);
            updateActiveTab(mealToShow);
        }

        function loadMenuByUser(selectedMeal) {
            if (isToday(userDate)) {
                userHasInteractedToday = true;
            }
            loadMenu(selectedMeal, userDate);
        }

        function updateDateDisplay(date) {
            document.getElementById("currentDate").innerText =
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function updateActiveTab(activeMeal) {
            document.querySelectorAll(".btn-meal").forEach(btn => btn.classList.remove("active-tab"));
            const activeBtn = document.getElementById(activeMeal.charAt(0).toUpperCase() + activeMeal.slice(1));
            if (activeBtn) {
                activeBtn.classList.add("active-tab");
            }
        }

        function changeDate(days) {
            userDate.setDate(userDate.getDate() + days);
            userHasInteractedToday = false;
            loadMenuByUser('breakfast');
        }

        function isToday(someDate) {
            const today = new Date();
            return someDate.getDate() === today.getDate() &&
                someDate.getMonth() === today.getMonth() &&
                someDate.getFullYear() === today.getFullYear();
        }

        // ======================================================
        // ============== NEW: GEMINI AI FUNCTIONS ==============
        // ======================================================

        async function getDietitianSuggestion() {
            const userPromptText = document.getElementById('ai-prompt').value;
            const suggestionBtn = document.getElementById('get-suggestion-btn');
            const responseContainer = document.getElementById('ai-response-container');
            const responseDiv = document.getElementById('ai-response');

            if (!userPromptText) {
                alert("Please enter your goal or requirement.");
                return;
            }

            // --- Show loading state ---
            suggestionBtn.disabled = true;
            suggestionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            responseContainer.style.display = 'block';
            responseDiv.innerHTML = 'Thinking... 🧠';

            // --- 1. Gather Context ---
            const activeMealTab = document.querySelector('.btn-meal.active-tab');
            const mealType = activeMealTab ? activeMealTab.innerText.split('\n')[1] : "the current meal";

            let menuItems = Array.from(document.querySelectorAll('#menuTable tr'))
                .map(row => row.cells[1] ? row.cells[1].innerText.trim() : null)
                .filter(Boolean);
            const menuContext = menuItems.join(', ');

            // --- 2. Construct the Prompt ---
            const fullPrompt = `You are an expert AI dietitian for a student mess. Your task is to provide helpful, actionable dietary advice based on the available menu and a student's specific requirement.

    **Context:**
    - Meal Type: ${mealType}
    - Available Menu Items: ${menuContext}
    - Student's Requirement: "${userPromptText}"

    **Your Instructions:**
    1. Analyze the student's requirement and the available menu.
    2. Suggest a combination of items from the menu that best fits their goal.
    3. Recommend practical portion sizes (e.g., "1 bowl of dal", "2 rotis", "a small portion of rice").
    4. Briefly explain *why* your suggestion is suitable for their goal.
    5. If the menu is not ideal for their goal, politely explain why and suggest what to look for in future meals.
    6. Format your response using clear headings, bold text, and bullet points (markdown). Do not use HTML tags.`;

            // --- 3. Make the API Call to YOUR Serverless Function ---
            try {
                // This is the new endpoint for your function
                const response = await fetch('/.netlify/functions/get-suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: fullPrompt }), // Send the full prompt
                });

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.statusText}`);
                }

                const data = await response.json();

                // Use the 'marked' library to convert markdown to HTML
                responseDiv.innerHTML = marked.parse(data.suggestion);

            } catch (error) {
                console.error("API Error:", error);
                responseDiv.innerHTML = `<p class="text-danger">Sorry, your dietBuddy is taking a small nap...</p>`;
            } finally {
                // --- Reset button ---
                suggestionBtn.disabled = false;
                suggestionBtn.innerText = 'Get Suggestion';
            }
        }
    </script>
</body>

</html>